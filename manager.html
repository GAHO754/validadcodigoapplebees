<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111317" />
  <title>Portal de Gerentes — Canje</title>

  <link rel="icon" type="image/png" sizes="32x32" href="manzanas.png">
  <link rel="stylesheet" href="manager.css" />

  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>

  <script src="firebase-config.js"></script>

  <script src="https://unpkg.com/html5-qrcode"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>

<body class="bg">
<noscript>Este portal requiere JavaScript.</noscript>

<header class="topbar">
  <div class="brand">
    <img src="manzanas.png" alt="logo" class="logo">
    <h1>Gerentes — Canje</h1>
  </div>
  <div class="actions" id="sessionActions" hidden>
    <span id="mgrEmail" class="muted"></span>
    <button id="btnLogout" class="btn ghost" type="button">Salir</button>
  </div>
</header>

<main class="container">

<section id="loginCard" class="card auth">
  <h2>Acceso de gerentes</h2>
  <p class="muted">Ingresa con tu correo corporativo.</p>
  <form id="loginForm" class="grid">
    <label class="field">
      <span>Correo</span>
      <input id="loginEmail" type="email" required placeholder="gerente@applebees.com">
    </label>
    <label class="field">
      <span>Contraseña</span>
      <input id="loginPass" type="password" required placeholder="••••••••">
    </label>
    <button class="btn primary">Entrar</button>
  </form>
  <p id="loginMsg" class="msg"></p>
</section>

<section id="dashboard" class="dash" hidden>

  <div class="kpi-grid">
    <div class="card kpi">
      <small>Total Histórico</small>
      <strong id="mTotal">0</strong>
    </div>
    <div class="card kpi">
      <small>Canjes Hoy</small>
      <strong id="mToday">0</strong>
    </div>
    <div class="card kpi">
      <small>Canjes Semanales</small>
      <strong id="mWeek">0</strong>
    </div>
    <div class="card kpi">
      <small>Gerentes Activos</small>
      <strong id="mManagers">0</strong>
    </div>
    <div class="card kpi">
      <small>Válidos (Tiempo Real)</small>
      <strong id="mValidToday" class="txt-ok">0</strong>
    </div>
    <div class="card kpi">
      <small>Fallidos (Tiempo Real)</small>
      <strong id="mFailedToday" class="txt-err">0</strong>
    </div>
  </div>

  <div class="grid2">
        <article class="card">
      <h3>Escanear código QR</h3>
      <div id="qrRegion" class="qr-region"></div>
      
      <div class="grid mt12" style="display: grid; gap: 10px;">
        <select id="cameraSelect" class="btn secondary"></select>
        <div class="row" style="display: flex; gap: 10px;">
          <button id="btnStartScan" class="btn primary w100">Iniciar Escáner</button>
          <button id="btnStopScan" class="btn secondary w100">Detener</button>
        </div>
      </div>
    </article>

    <article class="card">
      <h3>Buscar / validar código</h3>
      <div class="row">
        <input id="codeInput" class="mono" placeholder="AB3K9T6P2C">
        <button id="btnLookup" class="btn">Buscar</button>
      </div>

      <hr class="sep">

      <div id="redeemCard" hidden>
        <div class="redeem-header">
           <h4 id="rRewardName">—</h4>
           <div id="miniQRWrap" hidden><div id="miniQR"></div></div>
        </div>

        <div class="details-grid">
        <div><p class="label">Código</p><p class="mono" id="rCode">—</p></div>
        <div><p class="label">Estado</p><p id="rStatus" class="status">—</p></div>
        <div><p class="label">Expira</p><p id="rExpires">—</p></div>
        <div><p class="label">Costo</p><p id="rCost">0</p></div>
        <div><p class="label">Creado</p><p id="rCreated">—</p></div> 
      </div>
        
        <p class="label">Cliente UID</p>
        <p class="mono small" id="rUser">—</p>

          <div class="action-block mt12">
    <label class="field" style="margin-bottom: 10px; display: block;">
      <span style="color: var(--warn); font-weight: bold;">* Sucursal de Canje:</span>
      <select id="rStoreSelect" required style="border: 1px solid var(--accent);">
        <option value="">-- Selecciona Sucursal --</option>
        <option value="Applebee's Torres">Applebee's Torres</option>
        <option value="Applebee's Paseo Triunfo">Applebee's Paseo Triunfo</option>
        <option value="Applebee's Tecnológico">Applebee's Tecnológico</option>
      </select>
    </label>

  <textarea id="rNote" placeholder="Nota opcional (ej. Mesa 5)"></textarea>
  <button id="btnRedeem" class="btn primary w100" disabled>Confirmar Canje</button>
  <p id="redeemMsg" class="msg-small"></p>
</div>

        <div class="row mt12">
          <button id="btnInspect" class="btn secondary">Inspeccionar cliente</button>
        </div>
      </div>
    </article>
  </div>

  <article class="card mt24">
  <div class="row-between">
    <h3>Historial Reciente</h3>
    <button id="btnReloadAudit" class="btn ghost">Actualizar</button>
  </div>
  
  <div class="table-wrap">
    <table id="auditTable" class="table"> 
  <thead>
    <tr>
      <th>Fecha</th>
      <th>Código</th>
      <th>Premio</th>
      <th>Sucursal</th> <th>Costo</th>
      <th>Cliente</th>
      <th>Gerente</th>
      <th>Estado</th>
      <th>Nota</th>
    </tr>
  </thead>
  <tbody>
    <tr><td colspan="9" class="muted">Cargando bitácora...</td></tr>
  </tbody>
</table>
  </div>
</article>

</section>
</main>

<div id="alertOverlay" class="overlay" hidden>
  <div class="modal">
    <h3 id="alertTitle">Aviso</h3>
    <p id="alertText"></p>
    <div class="row mt16">
      <button id="alertClose" class="btn ghost">Cerrar</button>
      <button id="alertResume" class="btn primary">Reanudar Escáner</button>
    </div>
  </div>
</div>

<div id="inspectModal" class="overlay" hidden>
  <div class="modal modal-xl">
    <div class="modal-head">
      <div>
        <strong>Inspeccionar cliente</strong><br>
        <small id="inspectClientEmail">—</small>
      </div>
      <button id="btnCloseInspect" class="btn ghost">✕</button>
    </div>
    <div class="modal-body">
      <div class="inspect-kpis">
        <div class="kpi-card"><strong id="kpiPoints">0</strong><small>Puntos</small></div>
        <div class="kpi-card"><strong id="kpiRedeems">0</strong><small>Canjes</small></div>
        <div class="kpi-card"><strong id="kpiLastRedeem">—</strong><small>Último</small></div>
        <div><p class="label">Reward ID</p><p id="rRewardId">—</p></div>
        <div><p class="label">Creado</p><p id="rCreated">—</p></div>
        <div><p class="label">Estado real</p><p id="rState">—</p></div>

      </div>
      <h4>Historial</h4>
      <ul id="inspectHistory" class="list-small"><li>—</li></ul>
    </div>
    <div class="modal-foot">
      <button id="btnCancelInspect" class="btn ghost">Cancelar</button>
    </div>
  </div>
</div>

<div id="qrModal" class="overlay" hidden>
  <div class="modal text-center">
    <img id="qrFull" src="" alt="QR Grande">
    <p class="muted mt8">Cerrar</p>
  </div>
</div>

<script src="manager.js"></script>

</body>
</html>
