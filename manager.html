<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#111317" />
  <title>Portal de Gerentes — Canje</title>

  <link rel="icon" type="image/png" sizes="32x32" href="manzanas.png">
  <!-- Rompemos caché con ?v=4 por si ya tenías la hoja cargada -->
  <link rel="stylesheet" href="manager.css?v=4" />

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- Tu configuración -->
  <script src="firebase-config.js"></script>

  <!-- Lector QR -->
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body class="bg">
  <noscript>Este portal requiere JavaScript.</noscript>

  <!-- Topbar -->
  <header class="topbar">
    <div class="brand">
      <img src="manzanas.png" alt="Logo" class="logo">
      <h1>Gerentes — Canje</h1>
    </div>
    <div class="actions" id="sessionActions" hidden>
      <span id="mgrEmail" class="muted"></span>
      <button id="btnLogout" class="btn ghost" type="button">Salir</button>
    </div>
  </header>

  <main class="container">
    <!-- LOGIN -->
    <section id="loginCard" class="card auth">
      <h2>Acceso de gerentes</h2>
      <p class="muted">Ingresa con tu correo corporativo.</p>
      <form id="loginForm" class="grid" autocomplete="on">
        <label class="field">
          <span>Correo</span>
          <input id="loginEmail" type="email" placeholder="gerente@empresa.com" required>
        </label>
        <label class="field">
          <span>Contraseña</span>
          <input id="loginPass" type="password" placeholder="••••••••" required>
        </label>
        <button id="btnLogin" type="submit" class="btn primary">Entrar</button>
      </form>
      <p id="loginMsg" class="msg"></p>
    </section>

    <!-- DASHBOARD -->
    <section id="dashboard" class="dash" hidden>
      <div class="grid2">
        <!-- ESCÁNER QR -->
        <article class="card">
          <div class="card-header">
            <h3>Escanear código QR</h3>
            <div class="toggle">
              <label class="switch" title="Activar linterna (si el dispositivo lo permite)">
                <input id="switchTorch" type="checkbox">
                <span class="slider"></span>
              </label>
              <small>Linterna</small>
            </div>
          </div>

          <div id="qrRegion" class="qr-region" aria-label="Área de escaneo"></div>

          <div class="row mt8">
            <select id="cameraSelect" class="select" aria-label="Seleccionar cámara"></select>
            <button id="btnStartScan" class="btn" type="button">Iniciar</button>
            <button id="btnStopScan" class="btn ghost" type="button">Detener</button>
          </div>
          <small class="muted">También puedes ingresar el código manualmente.</small>
        </article>

        <!-- VALIDAR CÓDIGO MANUAL -->
        <article class="card">
          <h3>Buscar/validar por código</h3>
          <div class="row">
            <input id="codeInput" type="text" class="mono" placeholder="Ej. AB3K9T6P2C" aria-label="Código a validar">
            <button id="btnLookup" class="btn" type="button">Buscar</button>
          </div>

          <hr class="sep">

          <div id="redeemCard" class="redeem" hidden>
            <div class="redeem-head">
              <div>
                <h4 id="rRewardName">—</h4>
                <div class="tags">
                  <span class="tag">Costo: <b id="rCost">0</b> pts</span>
                  <span class="tag">Vence: <b id="rExpires">—</b></span>
                </div>
              </div>
              <div class="status" id="rStatus">—</div>
            </div>

            <div class="grid2 mt8">
              <div class="info">
                <p class="label">Código</p>
                <p class="mono" id="rCode">—</p>

                <p class="label">Cliente (UID)</p>
                <p class="mono" id="rUser">—</p>

                <p class="label">Recompensa</p>
                <p class="mono" id="rRewardId">—</p>
              </div>
              <div class="info">
                <p class="label">Creado</p>
                <p id="rCreated">—</p>

                <p class="label">Estado</p>
                <p id="rState">—</p>
              </div>
            </div>

            <div class="row mt12">
              <label class="field grow">
                <span>Notas (opcional)</span>
                <input id="rNote" type="text" placeholder="Ej. Entregado por Gerente No.2">
              </label>
              <button id="btnRedeem" class="btn primary" type="button">Canjear ahora</button>
            </div>

            <p id="redeemMsg" class="msg"></p>
          </div>
        </article>
      </div>

      <!-- AUDITORÍA / HISTORIAL -->
      <article class="card mt16">
        <div class="card-header">
          <h3>Últimos canjes</h3>
          <div class="row" style="gap:6px">
            <button id="btnReloadAudit" class="btn ghost" type="button">Actualizar</button>
          </div>
        </div>

        <!-- KPIs -->
        <div class="kpi-deck">
          <div class="kpi">
            <div class="kpi__label">Total</div>
            <div class="kpi__value" id="mTotal">0</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Hoy</div>
            <div class="kpi__value" id="mToday">0</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Últimos 7 días</div>
            <div class="kpi__value" id="mWeek">0</div>
          </div>
          <div class="kpi">
            <div class="kpi__label">Gerentes</div>
            <div class="kpi__value" id="mManagers">0</div>
          </div>
        </div>

        <!-- Toolbar de filtros -->
        <div class="toolbar">
          <div class="toolbar__group">
            <label class="field sm">
              <span>Desde</span>
              <input id="fFrom" type="date">
            </label>
            <label class="field sm">
              <span>Hasta</span>
              <input id="fTo" type="date">
            </label>
            <label class="field sm">
              <span>Estado</span>
              <select id="fStatus">
                <option value="">Todos</option>
                <option value="canjeado">Canjeado</option>
              </select>
            </label>
            <label class="field sm grow">
              <span>Gerente (correo)</span>
              <input id="fManager" type="text" placeholder="ej. gerente@empresa.com">
            </label>
          </div>
          <div class="toolbar__actions">
            <button id="fApply" class="btn" type="button">Buscar</button>
          </div>
        </div>

        <!-- Tabla -->
        <div class="table-wrap">
          <table class="table" id="auditTable">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Código</th>
                <th>Reward</th>
                <th>Pts</th>
                <th>Cliente</th>
                <th>Gerente</th>
                <th>Estado</th>
                <th>Nota</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </article>
    </section>
  </main>

  <footer class="foot">
    <small>© 2025 Great American Hospitality</small>
  </footer>

  <!-- Modal de alerta -->
<div id="alertOverlay" class="overlay" role="dialog" aria-modal="true" hidden>
  <div class="modal" id="alertModal" tabindex="-1">
    <h3 id="alertTitle">Aviso</h3>
    <p id="alertText" class="muted"></p>
    <div class="row right">
      <!-- Fallback inline por si algún listener externo falla -->
      <button id="alertClose" class="btn ghost" type="button" onclick="window.__hideAlert && window.__hideAlert(false)">Cerrar</button>
      <button id="alertResume" class="btn" type="button" onclick="window.__hideAlert && window.__hideAlert(true)">Reanudar escaneo</button>
    </div>
  </div>
</div>

<script>
(()=> {
  const overlay = document.getElementById('alertOverlay');
  const btnClose = document.getElementById('alertClose');
  const btnResume = document.getElementById('alertResume');
  const titleEl = document.getElementById('alertTitle');
  const textEl  = document.getElementById('alertText');

  // API mínima para abrir/cerrar (usada también como fallback)
  function _hide(resume){
    try { overlay.setAttribute('hidden',''); } catch {}
    try { if (resume && typeof window.startScan === 'function') window.startScan(); } catch {}
  }
  function _show(opts={}){
    try {
      titleEl.textContent = opts.title || 'Aviso';
      textEl.textContent  = opts.text  || '';
      overlay.removeAttribute('hidden');
      // Pinta estilo si existe .modal
      const m = overlay.querySelector('.modal');
      if (m) {
        m.classList.remove('warn','err','ok');
        m.classList.add(opts.toneType==='err'?'err':opts.toneType==='ok'?'ok':'warn');
      }
      // Muestra/oculta botón reanudar
      if (btnResume) btnResume.hidden = opts.canResume === false;
    } catch {}
  }

  // Expón global por si tu manager.js quiere usarlo
  window.__forceShowAlert = _show;
  window.__forceHideAlert = _hide;

  // Clicks de botones (funcionan aunque tu manager.js no cargue)
  btnClose?.addEventListener('click', () => _hide(false));
  btnResume?.addEventListener('click', () => _hide(true));

  // Clic fuera cierra
  overlay?.addEventListener('click', (ev) => {
    if (ev.target === overlay) _hide(false);
  });

  // Tecla ESC cierra
  document.addEventListener('keydown', (ev) => {
    if (!overlay.hasAttribute('hidden') && ev.key === 'Escape') _hide(false);
  });

  // Si en algún lado dejaste onClick inline, que apunte a esto:
  window.__hideAlert = (resume)=>_hide(!!resume);
})();
</script>



  <!-- Lógica -->
  <script src="manager.js"></script>
</body>
</html>
